<!doctype html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=960, user-scalable=no">
            <title>JSSpeccy v3</title>
        <script src="jsspeccy/jsspeccy.js"></script>
        <style>
            * {
                margin: 0;
                padding: 0;
            }
            body {
                background-color: #444;
            }
            #jsspeccy, #guiparent {
                width: 960px;
                margin: auto;
            }
            #jsspeccy {
                background-color: #FFF;
            }
            #guiparent {
                background-color: 444;
            }
            canvas {
                image-rendering: -moz-crisp-edges;
                image-rendering: -webkit-crisp-edges;
                image-rendering: pixelated;
                image-rendering: crisp-edges;
            }
            canvas#virtkeys {
                image-rendering: auto;
            }
        </style>
    </head>
    <body onload="onBodyLoad()">
        <div id="jsspeccy"></div>
        <div id="guiparent"><canvas id=virtkeys width=960></canvas></div>
    </body>

    <script src="canvasgui/PointerEventHandler.js"></script>
    <script src="canvasgui/canvasgui.js"></script>
    
    <script>
"use strict";
/*****************************************************************************/        
const onBodyLoad = function()
{
    const emu = JSSpeccy(document.getElementById('jsspeccy'), {
        zoom: 3,
        sandbox: true,
        autoLoadTapes: true,
        openUrl: 'https://davidprograma.github.io/ytc/09-ZxSpectrum/snake-1.01.tap',
        // openUrl: 'https://archive.org/download/ZXSpectrumTOSECSetV20171101LadyEklipse/Games/%5BZ80%5D/Manic%20Miner%20%281983%29%28Bug-Byte%29.zip/Manic%20Miner%20%281983%29%28Bug-Byte%29.z80',
    });
    window.emu = emu;

    const keystr = ''

    const win = new SingleWindow('virtkeys');
    win.setTargetSize(960, 576);

    new ImageButton(win, 0, 0, 240, 240, 'img/keyNONE.png', 'img/keyNONE.png');
    new MyImageButton(win, 240, 0, 240, 240, 'W', 87);
    new ImageButton(win, 480, 0, 240, 240, 'img/keyNONE.png', 'img/keyNONE.png');
    new MyImageButton(win, 720, 0, 240, 240, 'P', 80);

    new MyImageButton(win, 0, 240, 240, 240, 'A', 65);
    new MyImageButton(win, 240, 240, 240, 240, 'S', 83);
    new MyImageButton(win, 480, 240, 240, 240, 'D', 68);
    new MyImageButton(win, 720, 240, 240, 240, 'ENT', 13);

    new MyImageButton(win, 0*96, 480, 96,96, '1', 49);
    new MyImageButton(win, 1*96, 480, 96,96, '2', 50);
    new MyImageButton(win, 2*96, 480, 96,96, '3', 51);
    new MyImageButton(win, 3*96, 480, 96,96, '4', 52);
    new MyImageButton(win, 4*96, 480, 96,96, '5', 53);
    new MyImageButton(win, 5*96, 480, 96,96, '6', 54);
    new MyImageButton(win, 6*96, 480, 96,96, '7', 55);
    new MyImageButton(win, 7*96, 480, 96,96, '8', 56);
    new MyImageButton(win, 8*96, 480, 96,96, '9', 57);
    new MyImageButton(win, 9*96, 480, 96,96, 'M', 77);

    win._onload();
}

const keyCodes = {
    A: 65, B: 66, C: 67, D: 68, E: 69,
    F: 70, G: 71, H: 72, I: 73, J: 74,
    K: 75, L: 76, M: 77, N: 78, O: 79,
    P: 80, Q: 81, R: 82, S: 83, T: 84,
    U: 85, V: 86, W: 87, X: 88, Y: 89,
    Z: 90, _: 32, e: 13, c: 16, s: 17
};

// thanks @GlauberF for this gist: https://gist.github.com/GlauberF/d8278ce3aa592389e6e3d4e758e6a0c2

/**
 * Simulate a key event.
 * @param {Number} keyCode The keyCode of the key to simulate
 * @param {String} type (optional) The type of event : down, up or press. The default is down
 * @param {Object} modifiers (optional) An object which contains modifiers keys { ctrlKey: true, altKey: false, ...}
 */
function simulateKey (keyCode, type, modifiers) {
	var evtName = (typeof(type) === "string") ? "key" + type : "keydown";	
	var modifier = (typeof(modifiers) === "object") ? modifier : {};

	var event = document.createEvent("HTMLEvents");
	event.initEvent(evtName, true, false);
	event.keyCode = keyCode;
	
	for (var i in modifiers) {
		event[i] = modifiers[i];
	}

	document.dispatchEvent(event);
}

// Setup some tests

var onKeyEvent = function (event) {
	var state = "pressed";
	
	if (event.type !== "keypress") {
		state = event.type.replace("key", "");
	}
	
	console.log("Key with keyCode " + event.keyCode + " is " + state);
};

document.addEventListener("keypress", onKeyEvent, false);
document.addEventListener("keydown", onKeyEvent, false);
document.addEventListener("keyup", onKeyEvent, false);

class MyImageButton extends ImageButton
{
    constructor(parent, x, y, w, h, suffix, keyCode)
    {
        super(parent, x, y, w, h, 'img/key' + suffix + '.png', 'img/keyNONE.png');
        this.keyCode = keyCode;

        let that = this;
        this.on_begin = this.on_enter = function() {
            simulateKey(keyCode, 'down');
        }
        this.on_end = this.on_leave = function() {
            simulateKey(keyCode, 'up');
        }
    }
}

/*****************************************************************************/        
    </script>
</html>
